# ============================================
# DENDRITE IDE - CORE LEARNING METRICS
# ============================================
# Reference: cats.core.dendrite
# Eras: 1, 2, 3
# BuildBook: bldbk.core.dendrite

cats:
  meta:
    id: "cats.core.dendrite"
    name: "Dendrite Core - Learning Metrics"
    version: "0.2.0"
    domain: "learning-ide"
    eras: [1, 2, 3]
    owners: ["@shupp"]
    roadmap_ref: "rdmp.dendrite"
    buildbook_ref: "bldbk.core.dendrite"
    description: |
      Core learning metrics foundation including:
      - Rust/WASM engine for session tracking
      - VS Code integration layer
      - Growth dashboard with visualizations

  branding:
    product_name: "Dendrite"
    tagline: "Where learning takes root"
    command_prefix: "dendrite"
    storage_prefix: "dendrite"
    css_prefix: "dendrite"
    view_container:
      id: "growth"
      name: "Growth"
      icon: "pulse"

  # ============================================
  # FILE STRUCTURE
  # ============================================
  structure:
    root: "."
    tree:
      # ----------------------------------------
      # Rust workspace (Era 1)
      # ----------------------------------------
      - path: "crates/"
        type: directory
        description: "Rust workspace root"
        era: 1
        task: "1.1"
        
      - path: "crates/Cargo.toml"
        type: file
        description: "Workspace manifest"
        era: 1
        task: "1.1"
        
      - path: "crates/dendrite_core/"
        type: directory
        description: "WASM-compiled core engine"
        era: 1
        task: "1.2"
        
      - path: "crates/dendrite_core/Cargo.toml"
        type: file
        era: 1
        task: "1.2"
        
      - path: "crates/dendrite_core/src/lib.rs"
        type: file
        description: "Crate entry, WASM exports"
        era: 1
        task: "1.6"
        
      - path: "crates/dendrite_core/src/session.rs"
        type: file
        description: "Session tracking logic"
        era: 1
        task: "1.3"
        
      - path: "crates/dendrite_core/src/storage.rs"
        type: file
        description: "Persistence structures"
        era: 1
        task: "1.3"
        
      - path: "crates/dendrite_core/src/visualization.rs"
        type: file
        description: "Heatmap, charts data generation"
        era: 1
        task: "1.4"
        
      - path: "crates/dendrite_core/src/git.rs"
        type: file
        description: "Git commit correlation"
        era: 1
        task: "1.3"
        
      - path: "crates/dendrite_core/src/export.rs"
        type: file
        description: "Portfolio export formats"
        era: 1
        task: "1.5"

      # ----------------------------------------
      # VS Code contribution (Era 2)
      # ----------------------------------------
      - path: "src/vs/workbench/contrib/dendrite/"
        type: directory
        description: "Dendrite workbench contribution"
        era: 2
        task: "2.1"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/"
        type: directory
        description: "Browser-side implementation"
        era: 2
        task: "2.1"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/dendrite.contribution.ts"
        type: file
        description: "Contribution registration"
        era: 2
        task: "2.1"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/wasmBridge.ts"
        type: file
        description: "TypeScript <-> WASM interface"
        era: 2
        task: "2.2"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/storageService.ts"
        type: file
        description: "VS Code storage integration"
        era: 2
        task: "2.3"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/sessionLifecycleService.ts"
        type: file
        description: "Session start/stop/idle management"
        era: 2
        task: "2.4"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/gitIntegrationService.ts"
        type: file
        description: "Git commit tracking"
        era: 2
        task: "2.5"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/growthViewPaneContainer.ts"
        type: file
        description: "Growth view container"
        era: 2
        task: "2.6"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/dashboardView.ts"
        type: file
        description: "Main dashboard view"
        era: 2
        task: "2.7"
        note: "Basic structure in Era 2, full UI in Era 3"
        
      - path: "src/vs/workbench/contrib/dendrite/common/"
        type: directory
        description: "Shared types and constants"
        era: 2
        task: "2.1"
        
      - path: "src/vs/workbench/contrib/dendrite/common/types.ts"
        type: file
        description: "TypeScript data model types"
        era: 2
        task: "2.1"
        
      - path: "src/vs/workbench/contrib/dendrite/common/constants.ts"
        type: file
        description: "Constants (view IDs, storage keys, commands)"
        era: 2
        task: "2.1"
        note: "Language colors added in Era 3 task 3.13"

      # ----------------------------------------
      # Visualization renderers (Era 3)
      # ----------------------------------------
      - path: "src/vs/workbench/contrib/dendrite/browser/renderers/"
        type: directory
        description: "Visualization renderers"
        era: 3
        task: "3.1"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/renderers/heatmapRenderer.ts"
        type: file
        description: "Heatmap visualization renderer"
        era: 3
        task: "3.2"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/renderers/languageChartRenderer.ts"
        type: file
        description: "Language breakdown chart renderer"
        era: 3
        task: "3.3"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/renderers/streakRenderer.ts"
        type: file
        description: "Streak display renderer"
        era: 3
        task: "3.4"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/renderers/commitTimelineRenderer.ts"
        type: file
        description: "Git commit timeline renderer"
        era: 3
        task: "3.5"

      # ----------------------------------------
      # Commands (Era 3)
      # ----------------------------------------
      - path: "src/vs/workbench/contrib/dendrite/browser/commands/"
        type: directory
        description: "Command implementations"
        era: 3
        task: "3.6"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/commands/exportCommand.ts"
        type: file
        description: "Portfolio export command handler"
        era: 3
        task: "3.7"
        
      - path: "src/vs/workbench/contrib/dendrite/browser/commands/badgeCommand.ts"
        type: file
        description: "Badge copy command handler"
        era: 3
        task: "3.8"

      # ----------------------------------------
      # Scripts (Era 1, integrated Era 3)
      # ----------------------------------------
      - path: "scripts/build-dendrite.sh"
        type: file
        description: "Build WASM and copy to contribution"
        era: 1
        task: "1.7"
        note: "Integration into VS Code build in Era 3 task 3.25"

  # ============================================
  # MUTATIONS TO EXISTING VS CODE FILES
  # ============================================
  mutations:
    description: "Changes to existing VS Code files"
    files_modified:
      - path: "product.json"
        era: 3
        task: "3.21"
        status: "partial"
        changes:
          - action: "remove"
            keys: ["extensionsGallery", "extensionAllowedBadgeProviders", "extensionAllowedBadgeProvidersRegex"]
            status: "completed (Era 2)"
          - action: "remove_if_exists"
            pattern: "AIF-*"
            description: "Telemetry instrumentation keys"
            status: "completed (Era 2)"
          - action: "remove_if_exists"
            keys: ["aiKey", "msftInternalDomains", "sendASmile"]
            status: "pending (Era 3)"
          - action: "add"
            key: "dendrite"
            value: { "enabled": true }
            status: "completed (Era 2)"
            
      - path: "src/vs/workbench/contrib/extensions/browser/extensions.contribution.ts"
        era: 3
        task: "3.22"
        status: "pending"
        changes:
          - action: "comment_out"
            target: "ViewContainer registration"
            comment: "// DENDRITE: Disabled - replaced by Growth view"
            
      - path: "src/vs/workbench/workbench.common.main.ts"
        era: 2
        task: "2.1"
        status: "completed"
        changes:
          - action: "add_import"
            value: "import 'vs/workbench/contrib/dendrite/browser/dendrite.contribution';"
            
      - path: "src/vs/platform/telemetry/common/telemetryService.ts"
        era: 2
        task: "2.1"
        status: "completed"
        changes:
          - action: "replace_implementation"
            description: "Replace with NullTelemetryService"

  # ============================================
  # DATA MODEL
  # ============================================
  data_model:
    entities:
      - name: "Session"
        description: "A tracked period of focused work"
        rust_location: "crates/dendrite_core/src/session.rs"
        fields:
          - { name: "id", type: "u64", description: "Unique session identifier" }
          - { name: "started_at", type: "DateTime<Utc>", description: "When session began" }
          - { name: "ended_at", type: "Option<DateTime<Utc>>", description: "When session ended, None if active" }
          - { name: "active_time_ms", type: "u64", description: "Milliseconds of active editing (excludes idle)" }
          - { name: "keystroke_count", type: "u32", description: "Total keystrokes in session" }
          - { name: "files_edited", type: "Vec<String>", description: "Relative paths of edited files" }
          - { name: "languages", type: "HashMap<String, u64>", description: "Language -> time_ms mapping" }
          - { name: "idle_periods", type: "Vec<IdlePeriod>", description: "Tracked idle gaps" }
          - { name: "commits", type: "Vec<CommitRef>", description: "Git commits during session" }

      - name: "IdlePeriod"
        description: "A gap in activity"
        fields:
          - { name: "started_at", type: "DateTime<Utc>" }
          - { name: "ended_at", type: "Option<DateTime<Utc>>" }
          - { name: "duration_ms", type: "u64" }

      - name: "CommitRef"
        description: "Reference to a git commit"
        fields:
          - { name: "hash", type: "String", description: "Full SHA" }
          - { name: "short_hash", type: "String", description: "First 7 chars" }
          - { name: "message", type: "String", description: "Commit message (first line)" }
          - { name: "timestamp", type: "DateTime<Utc>" }
          - { name: "files_changed", type: "Vec<String>" }

      - name: "StoredSession"
        description: "Persisted session data"
        rust_location: "crates/dendrite_core/src/storage.rs"
        fields:
          - { name: "session", type: "Session" }
          - { name: "computed_stats", type: "SessionStats" }

      - name: "SessionStats"
        description: "Computed statistics for a session"
        fields:
          - { name: "total_duration_ms", type: "u64" }
          - { name: "active_percentage", type: "f32", description: "0.0-1.0" }
          - { name: "primary_language", type: "Option<String>" }
          - { name: "commit_count", type: "u32" }

      - name: "DailyAggregate"
        description: "Aggregated stats for one day"
        fields:
          - { name: "date", type: "NaiveDate" }
          - { name: "total_time_ms", type: "u64" }
          - { name: "total_keystrokes", type: "u32" }
          - { name: "files_count", type: "u32" }
          - { name: "sessions_count", type: "u32" }
          - { name: "commits_count", type: "u32" }
          - { name: "languages", type: "HashMap<String, u64>" }

      - name: "GrowthProfile"
        description: "Complete user learning profile"
        rust_location: "crates/dendrite_core/src/storage.rs"
        fields:
          - { name: "id", type: "String", description: "UUID" }
          - { name: "created_at", type: "DateTime<Utc>" }
          - { name: "sessions", type: "Vec<StoredSession>" }
          - { name: "daily_aggregates", type: "Vec<DailyAggregate>" }
          - { name: "lifetime_stats", type: "LifetimeStats" }

      - name: "LifetimeStats"
        description: "All-time statistics"
        fields:
          - { name: "total_time_ms", type: "u64" }
          - { name: "total_keystrokes", type: "u64" }
          - { name: "total_sessions", type: "u32" }
          - { name: "total_commits", type: "u32" }
          - { name: "current_streak", type: "u32" }
          - { name: "longest_streak", type: "u32" }
          - { name: "languages", type: "HashMap<String, u64>" }

      - name: "HeatmapCell"
        description: "Single cell in activity heatmap"
        rust_location: "crates/dendrite_core/src/visualization.rs"
        fields:
          - { name: "day", type: "u8", description: "0-6, Monday-Sunday" }
          - { name: "week", type: "u8", description: "Week offset from now" }
          - { name: "hour", type: "u8", description: "0-23" }
          - { name: "intensity", type: "f32", description: "0.0-1.0 normalized" }
          - { name: "raw_minutes", type: "u32" }

      - name: "HeatmapData"
        description: "Complete heatmap dataset"
        fields:
          - { name: "cells", type: "Vec<HeatmapCell>" }
          - { name: "max_minutes", type: "u32" }
          - { name: "weeks", type: "u8" }
          - { name: "total_minutes", type: "u32" }

      - name: "LanguageStat"
        description: "Statistics for one language"
        fields:
          - { name: "language", type: "String" }
          - { name: "time_ms", type: "u64" }
          - { name: "files_count", type: "u32" }
          - { name: "percentage", type: "f32" }
          - { name: "color", type: "String", description: "Hex color for display" }

      - name: "ExportOptions"
        description: "Configuration for portfolio export"
        rust_location: "crates/dendrite_core/src/export.rs"
        fields:
          - { name: "format", type: "ExportFormat" }
          - { name: "date_range", type: "Option<(DateTime<Utc>, DateTime<Utc>)>" }
          - { name: "include_commits", type: "bool" }
          - { name: "include_files", type: "bool" }

    enums:
      - name: "SessionState"
        values:
          - { key: "ACTIVE", value: "active" }
          - { key: "IDLE", value: "idle" }
          - { key: "PAUSED", value: "paused" }
          - { key: "ENDED", value: "ended" }

      - name: "ExportFormat"
        values:
          - { key: "JSON", value: "json" }
          - { key: "MARKDOWN", value: "markdown" }
          - { key: "SVG_HEATMAP", value: "svg_heatmap" }
          - { key: "BADGE_SVG", value: "badge_svg" }
          - { key: "BADGE_URL", value: "badge_url" }

  # ============================================
  # WASM INTERFACE
  # ============================================
  wasm_interface:
    description: "Functions exported from Rust to TypeScript"
    module_name: "dendrite_core"
    
    exports:
      # Session management
      - { name: "init_session", signature: "() -> SessionHandle", description: "Start a new tracking session" }
      - { name: "record_keystroke", signature: "(handle: SessionHandle) -> void" }
      - { name: "record_file_edit", signature: "(handle: SessionHandle, file_path: string, language: string) -> void" }
      - { name: "mark_idle", signature: "(handle: SessionHandle) -> void" }
      - { name: "resume_from_idle", signature: "(handle: SessionHandle) -> void" }
      - { name: "end_session", signature: "(handle: SessionHandle) -> SessionStats" }
      - { name: "get_active_session_stats", signature: "(handle: SessionHandle) -> SessionStats" }
      
      # Storage operations
      - { name: "serialize_session", signature: "(handle: SessionHandle) -> string", description: "JSON string for persistence" }
      - { name: "save_session_to_profile", signature: "(profile_json: string, session_json: string) -> string", description: "Returns updated profile JSON" }
      - { name: "create_empty_profile", signature: "() -> string" }
      - { name: "get_profile_stats", signature: "(profile_json: string) -> LifetimeStats" }
      - { name: "get_current_streak", signature: "(profile_json: string) -> u32" }
      - { name: "get_longest_streak", signature: "(profile_json: string) -> u32" }
      
      # Git
      - { name: "add_commit_to_session", signature: "(handle: SessionHandle, commit_json: string) -> void" }
      - { name: "get_commit_correlations", signature: "(profile_json: string) -> string" }
      
      # Visualization
      - { name: "generate_heatmap", signature: "(profile_json: string, weeks: u8) -> HeatmapData" }
      - { name: "generate_hourly_distribution", signature: "(profile_json: string) -> string" }
      - { name: "generate_language_breakdown", signature: "(profile_json: string) -> Vec<LanguageStat>" }
      - { name: "get_daily_aggregates", signature: "(profile_json: string, days: u32) -> string" }
      
      # Export
      - { name: "export_json", signature: "(profile_json: string, options_json: string) -> string" }
      - { name: "export_markdown", signature: "(profile_json: string, options_json: string) -> string" }
      - { name: "export_heatmap_svg", signature: "(profile_json: string, weeks: u8) -> string" }
      - { name: "generate_badge_svg", signature: "(profile_json: string) -> string" }
      - { name: "generate_badge_url", signature: "(profile_json: string) -> string" }

  # ============================================
  # COMMANDS
  # ============================================
  commands:
    description: "VS Code commands registered by Dendrite"
    prefix: "dendrite"
    era: 3
    
    items:
      - id: "dendrite.pauseSession"
        title: "Dendrite: Pause Session"
        description: "Manually pause the current session"
        keybinding: null
        task: "3.9"
        
      - id: "dendrite.resumeSession"
        title: "Dendrite: Resume Session"
        description: "Resume a paused session"
        keybinding: null
        task: "3.9"
        
      - id: "dendrite.exportPortfolio"
        title: "Dendrite: Export Portfolio"
        description: "Export learning data in various formats"
        keybinding: null
        task: "3.7"
        
      - id: "dendrite.copyBadge"
        title: "Dendrite: Copy Badge"
        description: "Copy markdown badge to clipboard"
        keybinding: null
        task: "3.8"
        
      - id: "dendrite.openGrowth"
        title: "Dendrite: Open Growth"
        description: "Focus the Growth view"
        keybinding: "ctrl+shift+g"
        task: "3.9"
        
      - id: "dendrite.showStats"
        title: "Dendrite: Show Today's Stats"
        description: "Show quick stats in notification"
        keybinding: null
        task: "3.9"

  # ============================================
  # SETTINGS
  # ============================================
  settings:
    description: "VS Code settings contributed by Dendrite"
    prefix: "dendrite"
    era: 3
    
    items:
      - id: "dendrite.enabled"
        type: "boolean"
        default: true
        description: "Enable Dendrite session tracking"
        task: "3.11"
        
      - id: "dendrite.idleThresholdMs"
        type: "number"
        default: 300000
        description: "Milliseconds of inactivity before marking idle (default 5 min)"
        task: "3.11"
        
      - id: "dendrite.autoStart"
        type: "boolean"
        default: true
        description: "Automatically start session on editor focus"
        task: "3.11"
        
      - id: "dendrite.trackGit"
        type: "boolean"
        default: true
        description: "Correlate sessions with git commits"
        task: "3.11"
        
      - id: "dendrite.heatmapWeeks"
        type: "number"
        default: 12
        description: "Number of weeks to show in heatmap"
        task: "3.11"
        
      - id: "dendrite.showStreakNotification"
        type: "boolean"
        default: true
        description: "Show notification when streak increases"
        task: "3.11"

  # ============================================
  # UI COMPONENTS
  # ============================================
  ui:
    view_containers:
      - id: "growth"
        name: "Growth"
        location: "activitybar"
        icon: "pulse"
        order: 100
        era: 2
        task: "2.6"
        file: "src/vs/workbench/contrib/dendrite/browser/growthViewPaneContainer.ts"

    views:
      - id: "dendrite.dashboard"
        name: "Dashboard"
        container: "growth"
        type: "webview"
        era: 2
        task: "2.7"
        file: "src/vs/workbench/contrib/dendrite/browser/dashboardView.ts"
        
    dashboard_layout:
      note: "All sections implemented in Era 3"
      sections:
        - { id: "header", components: ["session_indicator", "export_button"], task: "3.14" }
        - { id: "streak", components: ["streak_display"], task: "3.15", renderer: "3.4" }
        - { id: "today", components: ["today_stats"], task: "3.16" }
        - { id: "heatmap", components: ["activity_heatmap"], task: "3.17", renderer: "3.2" }
        - { id: "languages", components: ["language_chart"], task: "3.18", renderer: "3.3" }
        - { id: "git", components: ["commit_timeline"], tab: true, task: "3.19", renderer: "3.5" }

    status_bar:
      - id: "dendrite.sessionStatus"
        alignment: "right"
        priority: 100
        tooltip: "Dendrite: Click for stats"
        command: "dendrite.showStats"
        era: 3
        task: "3.20"

  # ============================================
  # BUILD CONFIGURATION
  # ============================================
  config:
    build_requirements:
      - { tool: "rustc", version: ">=1.70.0", install: "https://rustup.rs" }
      - { tool: "wasm-pack", version: ">=0.12.0", install: "cargo install wasm-pack" }
      - { tool: "node", version: ">=18.0.0" }

    storage_keys:
      - { key: "dendrite.profile", scope: "global", description: "Complete GrowthProfile JSON" }
      - { key: "dendrite.activeSession", scope: "workspace", description: "Current session handle if any" }

    language_colors:
      description: "Default colors for language chart"
      era: 3
      task: "3.13"
      mapping:
        typescript: "#3178c6"
        javascript: "#f7df1e"
        python: "#3776ab"
        rust: "#dea584"
        go: "#00add8"
        java: "#b07219"
        csharp: "#239120"
        cpp: "#f34b7d"
        ruby: "#cc342d"
        swift: "#fa7343"
        kotlin: "#a97bff"
        other: "#6e7681"

  # ============================================
  # DEPENDENCIES
  # ============================================
  dependencies:
    rust_crates:
      - { name: "wasm-bindgen", version: "0.2", features: [] }
      - { name: "serde", version: "1.0", features: ["derive"] }
      - { name: "serde_json", version: "1.0" }
      - { name: "chrono", version: "0.4", features: ["serde", "wasmbind"] }
      - { name: "uuid", version: "1.0", features: ["v4", "serde"] }

    vscode_apis:
      - "IStorageService"
      - "ICodeEditor"
      - "ITextModel"
      - "ILifecycleService"
      - "IGitService"
      - "ICommandService"
      - "INotificationService"
      - "IViewPaneContainer"
